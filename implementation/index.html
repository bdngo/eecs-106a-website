<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Implementation | EECS 106A Final Project</title><meta name=keywords content><meta name=description content="Hardware Hardware design of FishBot Our hardware implementation consists of several key components as highlighted in the above figure. This includes:
Underactuated Soft Tail The tail mechanism is the primary actuator for our robot. It consists of a series of rigid segmented &ldquo;ribs&rdquo; joined together by revolute joints. From a kinematic perspective, this forms a multi-bar linkage system with a high degree of freedom. However, this entire mechanism is actuated by a single capstan cable drive connected to our servomotor."><meta name=author content="Stanley Wang, Bryan Ngo, Shaikh Shamsuddin, Khalid Durani, Eric Yang"><link rel=canonical href=http://bdngo.github.io/eecs-106a-website/implementation/><link crossorigin=anonymous href=/eecs-106a-website/assets/css/stylesheet.20938765b1a704f13e3850663233999bf875f2b80884c6a144ccb321e865b540.css integrity="sha256-IJOHZbGnBPE+OFBmMjOZm/h18rgIhMahRMyzIehltUA=" rel="preload stylesheet" as=style><link rel=icon href=http://bdngo.github.io/eecs-106a-website/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://bdngo.github.io/eecs-106a-website/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://bdngo.github.io/eecs-106a-website/favicon-32x32.png><link rel=apple-touch-icon href=http://bdngo.github.io/eecs-106a-website/apple-touch-icon.png><link rel=mask-icon href=http://bdngo.github.io/eecs-106a-website/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=http://bdngo.github.io/eecs-106a-website/implementation/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><meta property="og:title" content="Implementation"><meta property="og:description" content="Trajectory Control of a Bio-Inspired Soft Robot for Underwater Manipulation"><meta property="og:type" content="website"><meta property="og:url" content="http://bdngo.github.io/eecs-106a-website/implementation/"><meta property="og:site_name" content="FishBot"><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementation"><meta name=twitter:description content="Trajectory Control of a Bio-Inspired Soft Robot for Underwater Manipulation"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Implementation","item":"http://bdngo.github.io/eecs-106a-website/implementation/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://bdngo.github.io/eecs-106a-website/ accesskey=h title="EECS 106A Final Project (Alt + H)">EECS 106A Final Project</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://bdngo.github.io/eecs-106a-website/introduction/ title=Introduction><span>Introduction</span></a></li><li><a href=http://bdngo.github.io/eecs-106a-website/design/ title=Design><span>Design</span></a></li><li><a href=http://bdngo.github.io/eecs-106a-website/implementation/ title=Implementation><span class=active>Implementation</span></a></li><li><a href=http://bdngo.github.io/eecs-106a-website/results/ title=Results><span>Results</span></a></li><li><a href=http://bdngo.github.io/eecs-106a-website/conclusion/ title=Conclusion><span>Conclusion</span></a></li><li><a href=http://bdngo.github.io/eecs-106a-website/team/ title=Team><span>Team</span></a></li><li><a href=http://bdngo.github.io/eecs-106a-website/additional-materials/ title="Additional Materials"><span>Additional Materials</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=http://bdngo.github.io/eecs-106a-website/>Home</a></div><h1>Implementation</h1></header><div class=post-content><h1 id=hardware>Hardware<a hidden class=anchor aria-hidden=true href=#hardware>#</a></h1><figure><img loading=lazy src=../img/hw-design.png width=100% height=100%><figcaption>Hardware design of FishBot</figcaption></figure><p>Our hardware implementation consists of several key components as highlighted in the above figure. This includes:</p><ul><li><strong>Underactuated Soft Tail</strong> The tail mechanism is the primary actuator for our robot. It consists of a series of rigid segmented &ldquo;ribs&rdquo; joined together by revolute joints.
From a kinematic perspective, this forms a multi-bar linkage system with a high degree of freedom.
However, this entire mechanism is actuated by a single capstan cable drive connected to our servomotor.
When tension is applied in either direction in the cable, an overall deflection left/right is respectively produced in the overall tail. This highly underactuated assembly is then encased by a soft flexible sleeve cast from silicone rubber (Smooth-On DragonSkin 10).
This sleeve acts as the caudal fin of our fish robot, enabling undulatory propulstion through the water.</li></ul><figure><img loading=lazy src=../img/logistic-map.png width=100% height=100%><figcaption>Logistic mapping for tail angle</figcaption></figure><ul><li><strong>Waterproof Servomotor</strong> A waterproof servomotor is sourced with appropriate specifications to meet both speed and torque requirements for driving the tail mechanism. After assessing potential solutions, we utilize a FlashHobby 35kg metal geared servo from Amazon, with specifications listed in the <a href=../additional-materials/>additional materials</a> section of the website.</li><li><strong>Electronics Compartment</strong> A waterproof compartment is used to house a 2S 7.4V LiPo battery used to power our servomotor.
This compartment is fabricated from standard PLA material using a desktop FDM 3D printer.
The part is then treated for water resistance by painting with an XTC-3D epoxy coating.
A lid for easy access is laser cut from 1/4" acrylic, and secured to the compartment with M3 bolts and an O-ring gasket.</li><li><strong>ArUco Tag</strong> The pose of the FishBot is extracted from an ArUco tag affixed to the front of the robot.
This is created by hand-painting a thin wooden sheet using a permanent marker in order to create a waterproof component (standard printer paper quickly dissolves and loses integrity when submerged).</li><li><strong>Microcontroller (WiFi Antenna)</strong> Lastly, a floating anchor is created using a small section of pool noodle.
The FishBot is affixed to this anchor at its center of gravity in order to ensure proper balance in the water.
The ESP32 microcontroller is then affixed to this float and waterproofed using a plastic sheet.
This is done to ensure the antenna on our microcontroller is above water, since we determined that WiFi has substantial issues transmitting through water.</li></ul><h1 id=software>Software<a hidden class=anchor aria-hidden=true href=#software>#</a></h1><p>The project structure is as shown:</p><pre tabindex=0><code>eecs-106a-project
├── LICENSE
├── README.md
└── src
    ├── CMakeLists.txt
    └── fishbot
        ├── CMakeLists.txt
        ├── launch
        │   └── init.launch
        ├── msg
        │   └── FishError.msg
        ├── package.xml
        └── src
            ├── control.py
            ├── cv.py
            ├── http_client.ino
            ├── http_server.py
            ├── motion_planner.py
            └── wifi_credentials.h
</code></pre><h2 id=ros>ROS<a hidden class=anchor aria-hidden=true href=#ros>#</a></h2><p>The current ROS workflow can be entirely run with the following command (given <code>roscore</code> is running and the proper files have been sourced):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>roslaunch fishbot init.launch
</span></span></code></pre></div><p>Analyzing the launch file,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;launch&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;video_device&#34;</span> <span class=na>default=</span><span class=s>&#34;/dev/video0&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;image_width&#34;</span> <span class=na>default=</span><span class=s>&#34;640&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;image_height&#34;</span> <span class=na>default=</span><span class=s>&#34;480&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;markerId1&#34;</span> <span class=na>default=</span><span class=s>&#34;582&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;markerId2&#34;</span> <span class=na>default=</span><span class=s>&#34;100&#34;</span><span class=nt>/&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;markerSize1&#34;</span> <span class=na>default=</span><span class=s>&#34;0.06&#34;</span><span class=nt>/&gt;</span> <span class=c>&lt;!-- in meter --&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;markerSize2&#34;</span> <span class=na>default=</span><span class=s>&#34;0.08&#34;</span><span class=nt>/&gt;</span> <span class=c>&lt;!-- in meter --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;eye&#34;</span> <span class=na>default=</span><span class=s>&#34;left&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;marker_frame1&#34;</span> <span class=na>default=</span><span class=s>&#34;fish_frame&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;marker_frame2&#34;</span> <span class=na>default=</span><span class=s>&#34;target_frame&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;ref_frame&#34;</span> <span class=na>default=</span><span class=s>&#34;&#34;</span><span class=nt>/&gt;</span> <span class=c>&lt;!-- leave empty and the pose will be published wrt param parent_name --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;arg</span> <span class=na>name=</span><span class=s>&#34;corner_refinement&#34;</span> <span class=na>default=</span><span class=s>&#34;LINES&#34;</span> <span class=nt>/&gt;</span> <span class=c>&lt;!-- NONE, HARRIS, LINES, SUBPIX --&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;node</span> <span class=na>name=</span><span class=s>&#34;usb_cam&#34;</span> <span class=na>pkg=</span><span class=s>&#34;usb_cam&#34;</span> <span class=na>type=</span><span class=s>&#34;usb_cam_node&#34;</span> <span class=na>output=</span><span class=s>&#34;screen&#34;</span> <span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;video_device&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg video_device)&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;image_width&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg image_width)&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;image_height&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg image_height)&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;pixel_format&#34;</span> <span class=na>value=</span><span class=s>&#34;mjpeg&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;camera_frame_id&#34;</span> <span class=na>value=</span><span class=s>&#34;usb_cam&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;io_method&#34;</span> <span class=na>value=</span><span class=s>&#34;mmap&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/node&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;node</span> <span class=na>pkg=</span><span class=s>&#34;aruco_ros&#34;</span> <span class=na>type=</span><span class=s>&#34;single&#34;</span> <span class=na>name=</span><span class=s>&#34;aruco_fish&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;remap</span> <span class=na>from=</span><span class=s>&#34;/camera_info&#34;</span> <span class=na>to=</span><span class=s>&#34;/usb_cam/camera_info&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;remap</span> <span class=na>from=</span><span class=s>&#34;/image&#34;</span> <span class=na>to=</span><span class=s>&#34;/usb_cam/image_raw&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;image_is_rectified&#34;</span> <span class=na>value=</span><span class=s>&#34;True&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;marker_size&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg markerSize1)&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;marker_id&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg markerId1)&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;reference_frame&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg ref_frame)&#34;</span><span class=nt>/&gt;</span> <span class=c>&lt;!-- frame in which the marker pose will be refered --&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;camera_frame&#34;</span> <span class=na>value=</span><span class=s>&#34;base_link1&#34;</span><span class=nt>/&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;marker_frame&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg marker_frame1)&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;corner_refinement&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg corner_refinement)&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/node&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;node</span> <span class=na>pkg=</span><span class=s>&#34;aruco_ros&#34;</span> <span class=na>type=</span><span class=s>&#34;single&#34;</span> <span class=na>name=</span><span class=s>&#34;aruco_target&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;remap</span> <span class=na>from=</span><span class=s>&#34;/camera_info&#34;</span> <span class=na>to=</span><span class=s>&#34;/usb_cam/camera_info&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;remap</span> <span class=na>from=</span><span class=s>&#34;/image&#34;</span> <span class=na>to=</span><span class=s>&#34;/usb_cam/image_raw&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;image_is_rectified&#34;</span> <span class=na>value=</span><span class=s>&#34;True&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;marker_size&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg markerSize2)&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;marker_id&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg markerId2)&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;reference_frame&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg ref_frame)&#34;</span><span class=nt>/&gt;</span> <span class=c>&lt;!-- frame in which the marker pose will be refered --&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;camera_frame&#34;</span> <span class=na>value=</span><span class=s>&#34;base_link2&#34;</span><span class=nt>/&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;marker_frame&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg marker_frame2)&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;param</span> <span class=na>name=</span><span class=s>&#34;corner_refinement&#34;</span> <span class=na>value=</span><span class=s>&#34;$(arg corner_refinement)&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/node&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nt>&lt;node</span> <span class=na>name=</span><span class=s>&#34;motion_planner&#34;</span> <span class=na>pkg=</span><span class=s>&#34;fishbot&#34;</span> <span class=na>type=</span><span class=s>&#34;motion_planner.py&#34;</span> <span class=na>output=</span><span class=s>&#34;screen&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;node</span> <span class=na>name=</span><span class=s>&#34;controller&#34;</span> <span class=na>pkg=</span><span class=s>&#34;fishbot&#34;</span> <span class=na>type=</span><span class=s>&#34;control.py&#34;</span> <span class=na>output=</span><span class=s>&#34;screen&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/launch&gt;</span>
</span></span></code></pre></div><p>The launch file first initializes several variables.
Notable ones highlighted are <code>markerSize1</code> and <code>markerSize2</code>, which tell <code>aruco_ros</code> how large the tags are assumed to be on a side.
Then, both the <code>usb_cam</code> and <code>aruco_ros</code> nodes are launched.
Two <code>aruco_ros</code> nodes are launch to represent the fish&rsquo;s tag, as well as the tag of a target to follow.
The topics they publish two are highlighted.
This initializes the raw camera feed and enables ArUco tag detection.
Finally, the custom <code>motion_planner</code> and <code>controller</code> nodes are launched, creating the full ROS workflow.</p><h3 id=cvpy><code>cv.py</code><a hidden class=anchor aria-hidden=true href=#cvpy>#</a></h3><h3 id=motion_plannerpy><code>motion_planner.py</code><a hidden class=anchor aria-hidden=true href=#motion_plannerpy>#</a></h3><p>This node allows converts the location of a given target point and the current location of the fish into an error that the fish can control.
This is sent to the <code>/controller</code> node to FishBot via the <code>/motion_plan</code> topic.
It is communicated via a custom <code>FishError</code> message:</p><pre tabindex=0><code>float64 distance_error
float64 angular_error
</code></pre><p>In order to read both the current position of the fish <em>and</em> a target node, we have to subscribe to two different topics.
This is done idiomatically using a custom class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>TagTracker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>fish_tag</span><span class=p>:</span>       <span class=n>Pose</span>     <span class=o>=</span> <span class=n>field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=n>Pose</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>target_tag</span><span class=p>:</span>     <span class=n>Pose</span>     <span class=o>=</span> <span class=n>field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=n>Pose</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>distance_error</span><span class=p>:</span> <span class=nb>float</span>    <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s2>&#34;inf&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>angular_error</span><span class=p>:</span>  <span class=nb>float</span>    <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s2>&#34;inf&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>In order to determine if the fish is ready to move to the next control point, we insert this condition to the callback method <code>TagTracker.target_tag_callback</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>target_tag_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=nb>abs</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>distance_error</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mf>0.1</span><span class=p>:</span>
</span></span><span class="line hl"><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>target_tag</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>control_pts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>joint_callback</span><span class=p>()</span>
</span></span></code></pre></div><p>If the distance error to the current node is within a given tolerance, it will iterate to the next control node.
Examining the <code>TagTracker.joint_callback</code> method, we first find the \(xy\)-plane positions of FishBot and the target point.
From there, we can derive the Euclidean distance error.
We can similarly derive the angular error after offsetting by FishBot&rsquo;s current orientation, derived from its quaternion pose.
The lines of interest are highlighted:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>joint_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class="line hl"><span class=cl>    <span class=n>delta_x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fish_tag</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>target_tag</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span>
</span></span><span class="line hl"><span class=cl>    <span class=n>delta_y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fish_tag</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>y</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>target_tag</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>y</span>
</span></span><span class=line><span class=cl>    <span class=n>fish_quaternion</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fish_tag</span><span class=o>.</span><span class=n>orientation</span><span class=o>.</span><span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fish_tag</span><span class=o>.</span><span class=n>orientation</span><span class=o>.</span><span class=n>y</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fish_tag</span><span class=o>.</span><span class=n>orientation</span><span class=o>.</span><span class=n>z</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fish_tag</span><span class=o>.</span><span class=n>orientation</span><span class=o>.</span><span class=n>w</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class="line hl"><span class=cl>    <span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>yaw</span> <span class=o>=</span> <span class=n>tft</span><span class=o>.</span><span class=n>euler_from_quaternion</span><span class=p>(</span><span class=n>fish_quaternion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>distance_error</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>delta_x</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>delta_y</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>angular_error</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>atan2</span><span class=p>(</span><span class=n>delta_y</span><span class=p>,</span> <span class=n>delta_x</span><span class=p>)</span> <span class=o>-</span> <span class=n>yaw</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>angular_error</span> <span class=o>&lt;</span> <span class=o>-</span><span class=n>math</span><span class=o>.</span><span class=n>pi</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>angular_error</span> <span class=o>+=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>math</span><span class=o>.</span><span class=n>pi</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>angular_error</span> <span class=o>&gt;</span> <span class=n>math</span><span class=o>.</span><span class=n>pi</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Want to bound the right turn angular error at pi</span>
</span></span><span class=line><span class=cl>        <span class=c1># Want to bound the left turn angular at -pi</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>angular_error</span> <span class=o>-=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>math</span><span class=o>.</span><span class=n>pi</span>
</span></span></code></pre></div><h3 id=controlpy><code>control.py</code><a hidden class=anchor aria-hidden=true href=#controlpy>#</a></h3><p>Based on the distance and angular error, we can determine the command to give to FishBot.
These are defined as classes, allowing for extensibility:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ESP32Command</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DoneCommand</span><span class=p>(</span><span class=n>ESP32Command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;DONE</span><span class=se>\n</span><span class=s2>0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ForwardCommand</span><span class=p>(</span><span class=n>ESP32Command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;FRWD</span><span class=se>\n</span><span class=s2>0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TurnCommand</span><span class=p>(</span><span class=n>ESP32Command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>strength</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;TURN</span><span class=se>\n</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>strength</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>If both errors are satisfactory, FishBot is given a <code>DoneCommand</code>.
If only the angular error is satisfactory, FishBot is given a <code>ForwardCommand</code>.
Otherwise, FishBot is given a <code>TurnCommand</code>.
Utilizing the logistic map from our <a href=../design/>design</a>, we can derive the necessary strength to drive the fish to a given angle:
\[
|S| =
\begin{cases}
S_{max} & |e_\theta| > S_{max} \\
S_{min} & |e_\theta| &lt; S_{min} \\
\frac{1}{B} \ln\left(\frac{A}{|e_\theta|} - 1\right) + C & \text{otherwise}
\end{cases}
\]
where \(A\) and \(B\) are constants experimentally derived, and \(e_\theta\) is the angular error in degrees.
The sign of the strength is determined by the direction of desired motion.
The result is saturated to between both safe angular displacements allowed by FishBot&rsquo;s motor and overcoming the viscosity of water.</p><h1 id=wireless-communication>Wireless Communication<a hidden class=anchor aria-hidden=true href=#wireless-communication>#</a></h1><figure><img loading=lazy src=../img/wifi-diagram.png width=100% height=100%><figcaption>Diagram of wireless communication protocol</figcaption></figure><p>The microcontroller on the ESP32 <em>does not</em> run ROS.
The exact commands it needs to run are calculated on a host computer and transmitted wirelessly.
This is done via a WiFi interface.
The result of the <code>/controller</code> node is translated into an angular position to drive FishBot&rsquo;s tail to.
The resultant &ldquo;strength&rdquo; is written to a file on disk with the following grammar:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bnf data-lang=bnf><span class=line><span class=cl><span class=p>&lt;</span><span class=nc>command</span><span class=p>&gt;</span> <span class=o>::=</span> &#34;DONE\n0&#34; | &#34;FWRD\n0&#34; | <span class=p>&lt;</span><span class=nc>turn</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nc>turn</span><span class=p>&gt;</span> <span class=o>::=</span> &#34;TURN\n&#34; n
</span></span></code></pre></div><p>where \(n\) is some integer between \(\pm 50\).
For example, if we wanted to tell FishBot to move the tail 34° to the right, then assuming rightwards is positive, the file would look like:</p><pre tabindex=0><code>TURN
34
</code></pre><p>While the ROS nodes are running, there is a Python HTTP server also running.
This server hosts the exact file to the LAN, which any computer connected to the same network can also access.
Every clock cycle of the ESP32, it queries this URL.
The payload is then parsed to determine the exact command FishBot can execute as well as the strength of it, if it is a turn.
This setup has a latency on the order of hundreds of milliseconds.</p><h2 id=esp32>ESP32<a hidden class=anchor aria-hidden=true href=#esp32>#</a></h2><p>The ESP32 connects to a locally hosted server that will send the motion commands to the FishBot.
By connecting to the server through Wi-Fi, the FishBot can persistently see the commands being fed by the control node from the ROS running on a host system.
After reading the commands from the server, it decides on one of three motions for the FishBot: move straight forward, turn left by some angle, or turn right by some angle.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-arduino data-lang=arduino><span class=line><span class=cl><span class=kt>String</span> <span class=nf>http_GET_request</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>server</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>HTTPClient</span> <span class=n>http</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=c1>// Your IP address with path or Domain name with URL path 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>http</span><span class=p>.</span><span class=nf>begin</span><span class=p>(</span><span class=n>server</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>response_code</span> <span class=o>=</span> <span class=n>http</span><span class=p>.</span><span class=n>GET</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>String</span> <span class=n>payload</span> <span class=o>=</span> <span class=s>&#34;--&#34;</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>response_code</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>http</span><span class=p>.</span><span class=n>getString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> 
</span></span><span class=line><span class=cl>  <span class=n>http</span><span class=p>.</span><span class=nf>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>payload</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The ESP32 controls the servo motor. This means that we need to import the <code>ESP32Servo</code> library so that the microcontroller can control the servo motor using the appropiate functions provided by this library.
In conjuction, the ESP32 needs to initialize/set up several components necessary for achieving the desired motion of the FishBot, including the wireless connection, the trim of the servo motor, and the desired frequency.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-arduino data-lang=arduino><span class=line><span class=cl><span class=kt>void</span> <span class=nf>setup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// put your setup code here, to run once:
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nc>Serial</span><span class=p>.</span><span class=nf>begin</span><span class=p>(</span><span class=mi>115200</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>delay</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nc>WiFi</span><span class=p>.</span><span class=nf>begin</span><span class=p>(</span><span class=nf>SSID</span><span class=p>,</span> <span class=n>PWORD</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=nc>WiFi</span><span class=p>.</span><span class=n>status</span><span class=p>()</span> <span class=o>!=</span> <span class=n>WL_CONNECTED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>delay</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ESP32PWM</span><span class=o>::</span><span class=n>allocateTimer</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ESP32PWM</span><span class=o>::</span><span class=n>allocateTimer</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ESP32PWM</span><span class=o>::</span><span class=n>allocateTimer</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ESP32PWM</span><span class=o>::</span><span class=n>allocateTimer</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>tail_motor</span><span class=p>.</span><span class=n>setPeriodHertz</span><span class=p>(</span><span class=mi>50</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>tail_motor</span><span class=p>.</span><span class=nf>attach</span><span class=p>(</span><span class=n>servo_pin</span><span class=p>,</span> <span class=mi>500</span><span class=p>,</span> <span class=mi>2400</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>tail_motor</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=nf>trim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>delay</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Before we go into our loop function that will constanly feed motion commands to FishBot, we must define a method for moving its tail.
The <code>move_tail</code> function takes in the total amount of time (<code>moving_time</code>) that the FishBot should move for and generates a linear map between the angular displacement of FishBot&rsquo;s tail and the servo motor angle.
The loop terminates when</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-arduino data-lang=arduino><span class=line><span class=cl><span class=kt>void</span> <span class=nf>move_tail</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>b</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>moving_time</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>moveStartTime</span> <span class=o>=</span> <span class=nf>millis</span><span class=p>();</span> <span class=c1>// time when start moving
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>progress</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=n>progress</span> <span class=o>&lt;=</span> <span class=n>moving_time</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>progress</span> <span class=o>=</span> <span class=nf>millis</span><span class=p>()</span> <span class=o>-</span> <span class=n>moveStartTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>angle</span> <span class=o>=</span> <span class=nf>map</span><span class=p>(</span><span class=n>progress</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>moving_time</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>tail_motor</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=n>angle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>After initializing the ESP32 with the necessary setup code, we run a loop that constantly downloads and parses the server&rsquo;s messages. This allows the controller to dynamically change the behavior of the servo motor, thereby influencing the FishBot&rsquo;s motion on the fly.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-arduino data-lang=arduino><span class=line><span class=cl><span class=kt>void</span> <span class=nf>loop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// put your main code here, to run repeatedly:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>String</span> <span class=n>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nc>WiFi</span><span class=p>.</span><span class=n>status</span><span class=p>()</span> <span class=o>==</span> <span class=n>WL_CONNECTED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>http_GET_request</span><span class=p>(</span><span class=n>URL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>str_len</span> <span class=o>=</span> <span class=n>key</span><span class=p>.</span><span class=nf>length</span><span class=p>()</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>commands</span><span class=p>[</span><span class=n>str_len</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>key</span><span class=p>.</span><span class=nf>toCharArray</span><span class=p>(</span><span class=n>commands</span><span class=p>,</span> <span class=n>str_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>cmd</span> <span class=o>=</span> <span class=n>strtok</span><span class=p>(</span><span class=n>commands</span><span class=p>,</span> <span class=n>delim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>param</span> <span class=o>=</span> <span class=n>strtok</span><span class=p>(</span><span class=kt>NULL</span><span class=p>,</span> <span class=n>delim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>angle</span> <span class=o>=</span> <span class=n>atoi</span><span class=p>(</span><span class=n>param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span> <span class=n>frwd</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>move_tail</span><span class=p>(</span><span class=nf>trim</span><span class=p>,</span> <span class=nf>trim</span> <span class=o>+</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>200</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>move_tail</span><span class=p>(</span><span class=nf>trim</span> <span class=o>+</span> <span class=mi>30</span><span class=p>,</span> <span class=nf>trim</span> <span class=o>-</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>400</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>move_tail</span><span class=p>(</span><span class=nf>trim</span> <span class=o>-</span> <span class=mi>30</span><span class=p>,</span> <span class=nf>trim</span><span class=p>,</span> <span class=mi>200</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span> <span class=nf>turn</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>tail_motor</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=nf>trim</span> <span class=o>+</span> <span class=n>angle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>delay</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>move_tail</span><span class=p>(</span><span class=nf>trim</span> <span class=o>+</span> <span class=n>angle</span><span class=p>,</span> <span class=nf>trim</span><span class=p>,</span> <span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=computer-vision-cv>Computer Vision (CV)<a hidden class=anchor aria-hidden=true href=#computer-vision-cv>#</a></h2><p>The goal of the computer vision node is to take an image from the camera, process the image using the OpenCV library in Python, and detect the obstacles that are present in the tank.
To implement this node, we first downsampled the image by a factor of 2 due to the size of the image and to improve computational speed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>cv_image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=s2>&#34;cv_image.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># downsample cv_image by a factor of 2 using nearest interpolation</span>
</span></span><span class=line><span class=cl><span class=n>img_d</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>src</span><span class=o>=</span><span class=n>cv_image</span><span class=p>,</span> <span class=n>dsize</span><span class=o>=</span><span class=p>(</span><span class=n>cv_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>//</span><span class=mi>2</span><span class=p>,</span> <span class=n>cv_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>//</span><span class=mi>2</span><span class=p>),</span> <span class=n>interpolation</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>INTER_NEAREST</span><span class=p>)</span>
</span></span></code></pre></div><p>Then, we perform image processing using the functions in the OpenCV library.
To do so, we create a mask by defining lower and upper limits of BGR values to specifically threshold out the blue values in the image, which are the color of the two obstacles.
Then, we create a kernel and use it to remove some noise from the blue mask. Next, we use this final processed blue mask to form the threshold image of blue colors:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>hsvFrame</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>img_d</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2HSV</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># define BGR lower and upper limits to threshold blue color</span>
</span></span><span class=line><span class=cl><span class=n>blue_lower</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>100</span><span class=p>,</span> <span class=mi>80</span><span class=p>,</span> <span class=mi>10</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>blue_upper</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>120</span><span class=p>,</span> <span class=mi>255</span><span class=p>,</span> <span class=mi>255</span><span class=p>],</span> <span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># creates a mask</span>
</span></span><span class=line><span class=cl><span class=n>blue_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>inRange</span><span class=p>(</span><span class=n>hsvFrame</span><span class=p>,</span> <span class=n>blue_lower</span><span class=p>,</span> <span class=n>blue_upper</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># creates a kernel used to remove from mask</span>
</span></span><span class=line><span class=cl><span class=n>kernel</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>((</span><span class=mi>7</span><span class=p>,</span> <span class=mi>7</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># remove noise from the mask</span>
</span></span><span class=line><span class=cl><span class=n>blue_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>morphologyEx</span><span class=p>(</span><span class=n>blue_mask</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>MORPH_CLOSE</span><span class=p>,</span> <span class=n>kernel</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>blue_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>morphologyEx</span><span class=p>(</span><span class=n>blue_mask</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>MORPH_OPEN</span><span class=p>,</span> <span class=n>kernel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># creates thresholded blue image using the mask</span>
</span></span><span class=line><span class=cl><span class=n>thresholded_img</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>bitwise_and</span><span class=p>(</span><span class=n>img_d</span><span class=p>,</span> <span class=n>img_d</span><span class=p>,</span> <span class=n>mask</span><span class=o>=</span><span class=n>blue_mask</span><span class=p>)</span>
</span></span></code></pre></div><p>Finally, we upsample the image by a factor of 2 back to the size of the original image before we did any processing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># upsample the image back to the original cv_image by a factor of 2 using nearest interpolation</span>
</span></span><span class=line><span class=cl><span class=n>img_u</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>src</span><span class=o>=</span><span class=n>thresholded_img</span><span class=p>,</span> <span class=n>dsize</span><span class=o>=</span><span class=p>(</span><span class=n>cv_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>cv_image</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=n>interpolation</span><span class=o>=</span><span class=n>cv2</span><span class=o>.</span><span class=n>INTER_NEAREST</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>img_u</span> <span class=o>=</span> <span class=n>img_u</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span></code></pre></div><p>Here are the original and processed/thresholded images:</p><p>[ADD 2 IMAGES!!!!!!!!!!!!!]</p><p>As you can see, the code performed the color thresholding pretty well but there are some limitations that require some additional improvements in the future.
One limitation was that since we also had some blue tape on the edges of the tank, the code also caught some of those areas.
To ensure that only the obstacles are detected by the thresholding algorithm, we need to make sure that only the two obstacles themselves are blue.</p></div></main><footer class=footer><span>&copy; 2022 <a href=http://bdngo.github.io/eecs-106a-website/>EECS 106A Final Project</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>